# 面向对象电梯系列第一次指导书


### 摘要

​	本次作业的基本目标是模拟**单部多线程电梯**的运行。

### 重要通知

​	本次作业的互测时间安排有所调整，请见[互测时间调整](#互测时间调整)。

### 基本概念

- 电梯系统时间$T_{real}$：程序自开始运行以来花费的时间，即程序的真实运行时间(real time)
- 电梯系统运行花费总时间$T_{final}$：电梯最后输出关门的时间
- 系统时间上限$T_{max}$：$T_{real}$和$T_{final}$的上限
- 开关门窗口时间：电梯开门之后，关门之前的时间，包括开门和关门的时刻
- 数据基本限制：所有测试数据均需满足的限制
- 公测数据限制：中测和强测数据满足的限制
- 互测数据限制：互测数据需满足的限制

### 题目描述

#### 电梯系统说明

本次作业需要模拟一个多线程实时电梯系统，系统从标准输入中输入请求信息，程序进行接收和处理，模拟电梯运行，将必要的运行信息通过输出接口进行输出。

具体而言，本次作业电梯系统具有的功能为：上下行，开关门，以及模拟乘客的进出。

电梯系统**可以采用任意的调度策略**，即在任意时刻，系统选择上行还是下行，是否在某层开关门，都可自定义，只要保证在**电梯系统时间不超过系统时间上限**的前提下将所有的乘客送至目的地即可。

电梯每运行一层的时间为固定值，开关门的时间也为固定值，仅在**开关门窗口时间内允许乘客进出**。

此外，要求电梯能够调整移动策略，以适应不同的到达情况。举例而言，在上班高峰期，乘客会集中到达底层，并前往高楼层，那么此时电梯可以将乘客载满后再进行一次长途移动。[具体到达情况的需求](#到达模式)

#### 电梯参数说明

- <a name="可到达楼层">可到达楼层</a>：1-20层
- 初始位置：1层
- 数量：1部
- 移动速度：0.4s/层
- 开门速度：0.2s/次
- 关门速度：0.2s/次
- 限乘人数：6人

#### 电梯请求说明

本次作业的电梯，为一种比较特殊的电梯，学名叫做**目的选层电梯**（可以百度一下，确实是存在的，且已经投入了主流市场）。

大概意思是，**在电梯的每层入口，都有一个输入装置，让每个乘客输入自己的目的楼层**。电梯基于这样的一个目的地选择系统进行调度，将乘客运送到指定的目标楼层。

所以，一个电梯请求包含这个人的**出发楼层和目的楼层**，以及这个人的id（保证人员id唯一），请求内容将作为一个整体送入电梯系统，在整个运行过程中请求内容不会发生改变。

#### 电梯捎带规则说明

在不违反课程规则的前提下，我们对电梯的捎带策略不做限制。希望同学们多多阅读并自行探索相关算法，对电梯的捎带策略有自己的设计与思考。

为保证同学们实现的都为作业要求的**可捎带电梯**，我们对电梯的性能做一定的约束，采用**ALS调度策略**为性能**基准**（关于调度策略，欢迎大家积极上网找资料探索）。性能约束详见公测说明-正确性判断章节中关于$T_{max}$的部分。

##### ALS(可捎带电梯)规则介绍

- 可捎带电梯调度器将会新增**主请求**和**被捎带请求**两个概念

- 主请求选择规则：

  - 如果电梯中没有乘客，将请求队列中到达时间最早的请求作为主请求

  - 如果电梯中有乘客，将其中到达时间最早的乘客请求作为主请求

- 被捎带请求选择规则：

  - 电梯的主请求存在，即主请求到该请求进入电梯时尚未完成

  - 该请求到达请求队列的时间**小于等于**电梯到达该请求出发楼层关门的截止时间
  - 电梯的运行方向和该请求的目标方向一致。即电梯主请求的目标楼层和被捎带请求的目标楼层，两者在当前楼层的同一侧。

- 其他：

  - 标准ALS电梯不会连续开关门。即开门关门一次之后，如果请求队列中还有请求，不能立即再执行开关门操作，会先执行请求。

### 输入/输出和样例

#### 输入输出接口说明

- 本单元作业使用官方提供的输入输出接口进行输入输出。

- 输入接口提供了若干方法，通过调用方法可以直接获取所需数据对象。输入接口在**尝试**读取标准输入的内容时，对于正确的输入将成功解析，错误的则输出错误信息，但不会影响程序的正常运行。

- 输出子程序接受一个字符串，并附上时间戳后再输出。

- 详细的接口定义和使用方法见官方接口说明文档。

- 程序的输入输出为**实时交互**，评测机可以做到在某个时间点投放一定量的输入。


#### 输入数据

- <a name="到达模式">到达模式 </a>：第一行指示乘客的到达模式，格式为一个特定的字符串，仅可能为以下三种（注意**首字母大写**）：
  - `Night `：乘客在**Night 指令到达时**一次性全部到达，终点层都是底层。
  - `Morning `：乘客到达间隔不超过2s，起始层都是底层。
  - `Random`：允许任何到达情况出现
- 后续每一行是一个乘客的到达信息
  - 格式为：`乘客ID-FROM-起点层-TO-终点层`
  - 起点层不会和终点层相同
  - 乘客ID唯一
  - 乘客到达后会一直等待电梯，不会中途离开

#### 输出数据

- 电梯到达某一楼层：`[时间戳]ARRIVE-所在层`
- 电梯开门：`[时间戳]OPEN-所在层`
- 电梯关门：`[时间戳]CLOSE-所在层`
- 乘客进入电梯：`[时间戳]IN-乘客ID-所在层`
- 乘客离开电梯：`[时间戳]OUT-乘客ID-所在层`
- 通过调用输出接口的每一次输出将自动附加时间戳于头部，具体请参考**输出接口文档**，请不要试图伪造时间戳，否则会在实际评测时产生不一样的结果导致程序运行错误。

#### 样例

<table>
    <tr>
        <td>#</td>
        <td>输入</td>
        <td>输出</td>
        <td>说明</td>
    </tr>
    <tr>
        <td width = "100px">1</td>
        <td width = "200px">[0.0]Random<br />[0.0]1-FROM-1-TO-2</td>
        <td width = "300px">[ 0.0100]OPEN-1 <br />[ 0.0130]IN-1-1 <br />[ 0.4110]CLOSE-1 <br />[ 0.8120]ARRIVE-2 <br />[ 0.8130]OPEN-2 <br />[ 0.8130]OUT-1-2 <br />[ 1.2130]CLOSE-2</td>
        <td width = "360px">显然</td>
    </tr>
    <tr>
        <td>2</td>
        <td>[0.0]Morning <br />[0.0]1-FROM-1-TO-2 <br />[0.0]2-FROM-1-TO-2</td>
        <td>[ 0.0120]OPEN-1 <br />[   0.0160]IN-1-1 <br />[ 0.0170]IN-2-1 <br />[ 2.2180]CLOSE-1 <br />[ 2.6180]ARRIVE-2 <br />[ 2.6180]OPEN-2 <br />[ 2.6180]OUT-1-2 <br />[   2.6190]OUT-2-2 <br />[ 3.0180]CLOSE-2</td>
        <td>到达模式为Morning，电梯可以选择在等待一段时间后出发，同时运送乘客1和乘客2</td>
    </tr>
    <tr>
        <td>3</td>
        <td>[0.0]Random <br />[1.5]1-FROM-1-TO-2</td>
        <td>[ 1.3870]OPEN-1 <br />[ 1.3910]IN-1-1 <br />[ 1.7930]CLOSE-1 <br />[ 2.1940]ARRIVE-2 <br />[ 2.1940]OPEN-2 <br />[ 2.1940]OUT-1-2 <br />[ 2.5940]CLOSE-2</td>
        <td>输入的起始时间可以不从0.0开始（此处存在时间计测同步性问题，在样例说明部分会有详细的说明）</td>
    </tr>
    <tr>
        <td>4</td>
        <td>[0.0]Random <br />[2.3]1-FROM-2-TO-5 <br />[3.6]2-FROM-3-TO-4</td>
        <td>[ 2.7060]ARRIVE-2 <br />[ 2.7070]OPEN-2 <br />[ 2.7100]IN-1-2 <br />[ 3.1080]CLOSE-2 <br />[ 3.5120]ARRIVE-3 <br />[ 3.9120]ARRIVE-4 <br />[ 4.3130]ARRIVE-5 <br />[ 4.3140]OPEN-5 <br />[ 4.3140]OUT-1-5 <br />[ 4.7140]CLOSE-5 <br />[ 5.2130]ARRIVE-4 <br />[ 5.6130]ARRIVE-3 <br />[ 5.6140]OPEN-3 <br />[ 5.6140]IN-2-3 <br />[ 6.0150]CLOSE-3 <br />[ 6.4160]ARRIVE-4 <br />[ 6.4160]OPEN-4 <br />[ 6.4180]OUT-2-4 <br />[ 6.8170]CLOSE-4</td>
        <td>第一条请求的所在楼层可以不是1层（此处存在时间计测同步性问题，在样例说明部分会有详细的说明）  <br />电梯在到达5层后折返至3层接乘客2</td>
    </tr>
<tr>
        <td>5</td>
        <td>[1.0]Night <br /> [1.0]1-FROM-4-TO-1 <br /> [1.0]2-FROM-6-TO-1</td>
        <td>[   2.0300]ARRIVE-2  <br />[   2.4310]ARRIVE-3  <br />[   2.8310]ARRIVE-4  <br />[   2.8320]OPEN-4  <br />[   3.2330]IN-1-4  <br />[   3.2330]CLOSE-4  <br />[   3.6340]ARRIVE-5  <br />[   4.0340]ARRIVE-6  <br />[   4.0350]OPEN-6  <br />[   4.4350]IN-2-6  <br />[   4.4360]CLOSE-6  <br />[   4.8360]ARRIVE-5  <br />[   5.2370]ARRIVE-4  <br />[   5.6380]ARRIVE-3  <br />[   6.0380]ARRIVE-2  <br />[   6.4390]ARRIVE-1  <br />[   6.4390]OPEN-1  <br />[   6.4400]OUT-1-1  <br />[   6.4400]OUT-2-1  <br />[   6.8410]CLOSE-1</td>
        <td>到达模式为Night，所有请求同时到达，且目标为1层（此处存在时间计测同步性问题，在样例说明部分会有详细的说明） </td>
    </tr>
</table>



说明：

- 为了方便说明，指导书上提供的输入为这样的格式：`[x.x]yyyyyyyy`。
- 意思是在`x.x`这个时间点（相对于程序运行开始的时间，单位秒），输入`yyyyyyyy`这样的一行数据。
- 关于上面说到的时间计测同步性问题，在这里解释一下：
  - 直观地说，可能会观察到输入指令时间晚于做出反应的时间或反应时间明显晚于预期时间的现象。
  - 这个实际上不是程序的错误，而是由于评测机投放数据的系统、和程序输出接口，这两边的时间可能存在不同步导致的。
  - **这一问题是由于多线程测试不可避免的波动性导致的计时同步性误差，属于正常现象，不会被认定为错误**。（<del>当然，也不会出现故意提早的情况，因为程序本身就是实时交互，不可能做得到预知未来</del>）

### 测试数据限制说明

#### 数据基本限制

- 可输入电梯系统的指令数：**1~30条**（指令数为0或超过30均为不合法输入）。
- 系统时间上限$T_{max}$：电梯系统时间$T_{real}$和电梯系统运行花费总时间$T_{final}$的上限时间，**一旦超过将直接判定为TIME_LIMIT_EXCEED**。
- 对于特定的到达模式，请求需要满足相应的限制条件。


#### 公测数据限制

- 运行基准时间$T_{base}$：由课程组提供的`datacheck`程序对输入进行分析给出，计算$T_{base}$使用的策略为ALS调度策略。
- 系统时间上限$T_{max}$：计算方式为$T_{max} = \max\left(T_{base}+3, 1.05\cdot T_{base}\right)$
- 包括强测在内的数据都会保证正常程序的电梯系统时间不会超过$T_{max}$，也会**避免使用对边界情况较为敏感的数据**。
- 提示：**对于中测和强测数据，$T_{max}$将会严格限制为通过上述公式计算得到的值。**<del>所以，请不要试图用超长的sleep来回避线程安全停止的问题。</del>

#### 互测数据限制

- 系统时间上限$T_{max}$：对于互测数据，$T_{max}$为210s。
- 第一条指令的输入时间在1-5s间。
- 最后一条指令的输入时间不晚于70s。

### 公测说明

#### 正确性判断

- 总CPU时间限制为10s，满足该限制的程序才会判定为正确。请使用Wait-Notify的方式编程，**不要轮询**。

- 总real time时间限制为$T_{max}$，满足$T_{real}<T_{max}$的程序才会被判定为正确。这里再次说明$T_{max}$的标准：

  - 对于公测数据，$T_{max}$取决于$T_{base}$，计算方式为$T_{max} = \max\left(T_{base}+3, 1.05\cdot T_{base}\right)$，基准为ALS可捎带调度策略。
  - 对于互测数据，$T_{max}$为210s。

- 输出结果满足以下要求的程序才会判定为正确：

  - 电梯运行逻辑合理，即
    - 电梯到达一层后就可以输出开门信息，然后花0.2s开门，开门结束。
    
    - 电梯开门结束后，某一刻电梯花0.2s关门，然后输出关门信息，就可以离开楼层。
    
    - 乘客进出信息在电梯开门和关门输出之间。
      ```
      错误示例：
      OUT-1-1 ← 这个人没开门就出来了
      OPEN-1
      CLOSE-1
      ```
      
    - 电梯在两楼层间若发生移动，应满足移动时间要求
    
    - **反常识设定：**开门或关门的0.2s期间乘客仍然可以进出。~~纸片人没有厚度~~
    
    - 电梯系统结束运行时，所有的乘客都到达了目标楼层，且没有被困在电梯里。**最后输出关门的时间$T_{final}$不得超过$T_{max}$。**
    
    - 电梯只在[可到达楼层](#可到达楼层)运行。
    
  - 人员运行逻辑合理
      - 只有已经在电梯里的人可以出电梯，也只有不在电梯里的人可以进入电梯。
      - 如果电梯在楼层A，那么乘客显然也只能在楼层A进出。
      
  - 关于电梯载客量
  
      -   **电梯任何时候，内部的人数都必须小于等于轿厢容量限制**。
      -   也就是说，即便在OPEN、CLOSE中间，也不允许出现超过容量限制的中间情况。
  
  - 满足上述要求的一切输出结果都是正确的！
  
- 程序被判定为正确当且仅当以上三点要求均满足
#### 性能分的评判

在强测时，将电梯系统运行花费总时间$T_{final}$作为运行时间$\rm{time}$，计算相应的性能分。
设全体通过该数据点的同学的运行时间的平均值为$\rm{mean}$，标准差为$\rm{std}$。
设$x = \frac{\rm{mean}-\rm{time}}{\rm{std}}$，则通过多项式拟合，性能百分比为
$$
r\left(x\right) = 100\% \cdot 
\begin{cases}
1 & x \geq 1 \\\
0.17361111x^3 -0.05952381x^2 +0.73710317x +0.15119048 & -0.2 < x < 1 \\\
0 & x \leq -0.2
\end{cases}
$$
#### 分数判定和组成

本次作业基础分占比$85\%$，性能分占比$15\%$.

### 互测说明

- **程序在互测中的正确性判断规则与公测说明中的一致。**

- 所有提交的互测数据均需要满足以下输入格式（该格式与样例一致，可参考样例中的输入格式）：

  1. 需要额外附加时间戳`[time]`，其中time是一个保留一位小数的浮点数，比如`0.0`,`1.5`,`2.2`等。。
  2. 第一条数据必须为到达模式，其格式为`[<time>]<some pattern>`。
  3. 其余的输入为乘客请求，其格式为`[<time>]<id>-FROM-<x>-TO-<y>`。

  评测系统将使用请求发射器在对应的时间将请求送入标准输入。

- 所有提交的互测数据均需要满足数据基本限制和互测数据限制。**特别地，注意不同到达模式对指令的限制。**

- **随测试点提交的输出**中电梯最终的关门时间$T_{final}$不得大于150s。

- <a name="互测时间调整">**互测时间调整：互测开放时间延后至周一18:00，结束时间延后至周三上午9:30，提交冷却时间CD减为20min**</a>

### 提示和警示

#### 实现提示

- 电梯的"运行策略"实际上可以抽象为从一组待选任务当中选取一个来执行。可以先编写一个**候乘表类**来显示当前电梯系统中各层已有的乘客。再编写一个**策略类**，接受这个候乘表类，分析并输出一个目标楼层。因此，分析的过程被隐藏在了策略类内部。

- 将策略类作为电梯的一个属性，通过更换策略类，就可以灵活地切换执行策略。或应用工厂模式组装不同电梯。

- 电梯的运行流程可以抽象为：到达一层→开门→乘客进出→关门→寻找下一目标层→移动，可以使用状态模式建模。


#### 其他提示

- 如果还有人不知道标准输入、标准输出是啥的话，那在这里解释一下
  - 标准输入，直观来说就是屏幕输入
  - 标准输出，直观来说就是屏幕输出
  - 标准异常，直观来说就是报错的时候那堆红字
  - 想更加详细的了解的话，请去百度
- 关于接口的一些使用，可以在idea里面，按Ctrl+Q。将可以看到类和方法的使用格式以及注释（本次官方提供的接口均提供了中文版javadoc注释，Ctrl+Q可以直接查看）

#### 警示

- <font color = red>不要试图Hack评测机和官方接口，不要企图伪造时间戳，不要抄袭。如在互测中发现其他人的代码疑似存在上述行为，可向课程组举报。课程组感谢同学们为OO课程建设所作出的贡献。</font>
